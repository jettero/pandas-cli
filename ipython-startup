#!/usr/bin/env python
# coding: utf-8

import inspect
import pandas as pd

import pdc
import pdc.util
import pdc.parser
import pdc.op

pdc.util.set_say_level(pdc.util.SAY_INFO)

TA_FILES = list()


def sl(x):
    pdc.util.set_say_level(x)
    return pdc.util.SAY_LEVEL


def parse(x):
    try:
        return pdc.parser.parse(x, files=TA_FILES)
    except Exception as e:
        pdc.util.say_error(f'parse error: {e}')



from t.conftest import *


def unwrap_fixtures():
    g = globals()
    for name in g:
        try:
            item = g[name].__pytest_wrapped__.obj()
            if inspect.isgenerator(item):
                item = next(item)
            g[name] = item
        except AttributeError:
            pass
    TA_FILES.clear()
    for name in sorted(g):
        if name.startswith("ta_") and isinstance(obj := g[name], pdc.parser.File):
            TA_FILES.append(obj)


unwrap_fixtures()


/sl 'debug'
